# Задание
## Создать Docker Compose скрипт для развертки кластера из трех инстансов cassandra, причем каждый из них должен быть доступен из основной (локальной) сети по отдельному ip адресу
1. На машине А (ubuntu 24.04 lts) в локальной сети с ip 192.168.1.197 запускается скрипт docker-compose для поднятия 3 образов с ip адресами 192.168.1.200-202.
2. Затем с машины Б (ubuntu 24.04 lts) из той же локальной сети с ip 192.168.1.198 необходимо подключиться через cqlsh к каждой из машин-образов.
3. Настроить ssh для возможности подключения к 1.200 с 1.197
4. Все приведённые операции необходимо задокументировать и описать инструкцией с командами и объяснениями в Readme
5. Добавить скриншот результата в Readme.

## Создаем виртуальные машины согласно ТЗ
`vagrant up  `
### Устанавливаем docker на 192.168.1.197
`ansible-playbook install_docker.yml -i inventory.ini`


### Копируем файлы для сборки docker образа на машину A
`scp -r cassandra-cluster vagrant@192.168.1.197:  `


### Собираем образ для ноды с ssh доступом из cassandra:latest
```
vagrant ssh host-A
cd ./cassandra-cluster
docker build -t cassandra-ssh ./cassandra-ssh-docker
```

## Запускаем развертывание кластера
#### В скрипте удаляются тома контейнеров (полезно при пересоздании кластера). Добавлена задержка создания нод, чтобы seed-нода успела инициализироваться. 
#### Также добавляется автоматическое создание docker сети `macvlan` (По умолчанию, хост не может напрямую общаться с контейнерами в `macvlan` сети, даже если они находятся в одной подсети. Для этого необходимо создать дополнительный `macvlan` интерфейс на самом хосте с IP-адресом из той же подсети `macvlan`.)
```
chmod +x ./run.sh
sudo ./run.sh
```


#### Проверяем статус кластера
`docker exec -it cassandra-1 nodetool status`
#### Проверяем участие нод в gossip (пример получения уникального токена: STATUS_WITH_PORT:18:NORMAL,-1251892226658967644)
`docker exec cassandra-1 nodetool gossipinfo`


#### Пробуем подключиться по SSH c машины A
Добавляем интерфейс, правило и маршрут для него 
```
sudo ip link add link eth1 mac0 type macvlan mode bridge
sudo ip addr add 192.168.1.199/24 dev mac0
sudo ip link set mac0 up

sudo ip rule add from 192.168.1.199 table 100
sudo ip route add 192.168.1.0/24 dev mac0 src 192.168.1.199 table 100
```
Пробуем (явно указываем что подключаемся через созданный интерфейс)
`ssh -b 192.168.1.199 cassandra@192.168.1.200`


## Подключение с машины B через cqlsh к 192.168.1.200
#### устанавливаем пакет pipx для того, чтобы установить cqlsh (в ubuntu 24.04 пакет cassandra больше не доступен напрямую из стандартных репозиториев) и подключаемся к созданным хостам в docker compose

```
vagrant ssh host-B

sudo apt install pipx

pipx ensurepath && source ~/.bashrc # автоматически добавляется ~/.local/bin в PATH и перечитываем конфиг 

pipx install cqlsh

cqlsh 192.168.1.200
```


![3 образа с ip адресами 192.168.1.200-202](img/1.png)

![подключение через cqlsh](img/2.png)

![подключение ssh к 1.200 с 1.197](img/3.png)

